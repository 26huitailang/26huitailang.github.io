<!doctype html><html lang=en dir=auto><head><meta name=generator content="Hugo 0.139.2"><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Peter's Blog</title>
<meta name=keywords content="Blog,Peter"><meta name=description content="Sharing some notes here"><meta name=author content="Peter"><link rel=canonical href=https://26huitailang.github.io/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css integrity="sha256-1vzSCk+4bvpN+sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as=style><link rel=icon href=https://26huitailang.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://26huitailang.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://26huitailang.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://26huitailang.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://26huitailang.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://26huitailang.github.io/index.xml><link rel=alternate type=application/json href=https://26huitailang.github.io/index.json><link rel=alternate hreflang=en href=https://26huitailang.github.io/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://26huitailang.github.io/"><meta property="og:site_name" content="Peter's Blog"><meta property="og:title" content="Peter's Blog"><meta property="og:description" content="Sharing some notes here"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:image" content="https://26huitailang.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://26huitailang.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Peter's Blog"><meta name=twitter:description content="Sharing some notes here"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Organization","name":"Peter's Blog","url":"https://26huitailang.github.io/","description":"Sharing some notes here","logo":"https://26huitailang.github.io/%3Clink%20/%20abs%20url%3E","sameAs":["https://github.com/26huitailang"]}</script></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://26huitailang.github.io/ accesskey=h title="Home (Alt + H)"><img src=https://26huitailang.github.io/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://26huitailang.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://26huitailang.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://26huitailang.github.io/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li></ul></nav></header><main class=main><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent></h2></header><div class=entry-content><p>尝试golang的CI Golang基于Gitlab CI/CD部署方案 环境 gitlab:
docker，gitlab docker，gitlab-runner 用于集成部署的镜像制作，golang版本，和一些必须的工具（golint等） runner 注册和配置 定义规则，.gitlab-ci.yml 获取列表，go list ./... | grep -v /vendor/ 单元测试, go test -short 数据竞争, go test -race -short 代码覆盖率 构建 linter github + travis-ci:
先整理一个本地的测试方案 按照travis的golang指导写.travis-ci.yml 参考：
language: go go: - 1.9 - 1.8 - 1.7 branches: only: - master cache: directories: - $GOPATH/pkg/dep env: - DEP_VERSION="0.3.2" before_install: # Setup some env variables - GO_FILES=$(find . -iname '*.go' | grep -v /vendor/) # All the .go files, excluding vendor/ - PKGS=$(go list ./... | grep -v /vendor/) # All the import paths, excluding vendor/ # Setup dependency management tool - curl -L -s https://github.com/golang/dep/releases/download/v${DEP_VERSION}/dep-linux-amd64 -o $GOPATH/bin/dep - chmod +x $GOPATH/bin/dep # To install latest version, use `go get -u github.com/golang/dep/cmd/dep` # Install linters - go get -u github.com/golang/lint/golint # Linter - go get -u honnef.co/go/tools/cmd/megacheck # Badass static analyzer/linter - go get -u github.com/kisielk/errcheck # errcheck checks that you checked errors. # Install goveralls, Go integration for Coveralls.io. - go get -u github.com/mattn/goveralls install: - dep ensure script: - test -z $(gofmt -s -l $GO_FILES) # Fail if a .go file hasn't been formatted with gofmt - go vet $PKGS # go vet is the official Go static analyzer - megacheck $PKGS # "go vet on steroids" + linter - errcheck $PKGS # Check for unchecked errors - golint -set_exit_status $PKGS # One last linter # Run all the tests, track coverage in coveralls.io - go test -v -covermode=count -coverprofile=profile.cov $PKGS - goveralls -coverprofile=profile.cov -service=travis-ci</p></div><footer class=entry-footer>2 min&nbsp;·&nbsp;Peter</footer><a class=entry-link aria-label="post link to " href=https://26huitailang.github.io/posts/golang/ci/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent></h2></header><div class=entry-content><p>go doc godoc 命令godoc是一个很强大的工具，同样用于展示指定代码包的文档。并且提供网页选择。
开启godoc -http=localhost:6060。
可以在官方包之后的third-party部分找到对应的GOPATH里面自己的或下载的其他包。
go_doc go doc命令可以打印附于Go语言程序实体上的文档。我们可以通过把程序实体的标识符作为该命令的参数来达到查看其文档的目的。
下面是一个包的go doc输出：
package suite // import "learning/cobra_demo/download_suite/suite" Package suite to download one suite images. Now support meituri. func DonwloadSuite(iSuite ISuiteOperator, countFanOut int, folderPath string, title string) func IsDir(path string) bool func IsFile(path string) bool func IsFileOrFolderExists(path string) bool type ISuiteOperator interface{ ... } type MeituriSuite struct{ ... } func NewMeituriSuite(firstPage string) *MeituriSuite 还支持其他参数，-all可以一并显示文档等。</p></div><footer class=entry-footer>1 min&nbsp;·&nbsp;Peter</footer><a class=entry-link aria-label="post link to " href=https://26huitailang.github.io/posts/golang/go-doc/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent></h2></header><div class=entry-content><p>goroutine channel的坑 channel的关闭 for-range 知道channel的关闭，代码继续执行 for-select 不知道，用case v, ok:=&lt;-c:中的ok来判断 那么问题来了，如果是一个buffer channel，ok在关闭的时候可不是true，而是满足channel数据去完&amp;channel close，ok才会返回true，如果不这样设计的话，会导致数据丢失。 channel for-select 中break和return的问题 核心是，break在select中是只能跳出select，return是返回当前的函数。
package meituri import "fmt" type ISuiteOperator interface { GetPageURLs(chan string) GetImgURLs(chPage &lt;-chan string, chFailedImg &lt;-chan string) &lt;-chan string Download(chImg &lt;-chan string, chFailedImg chan string, folderPath string) &lt;-chan string } // DonwloadSuite to download one suite func DonwloadSuite(iSuite ISuiteOperator, countFanOut int, folderPath string) { chPage := make(chan string) chFailedImg := make(chan string) // 下载失败img放回 go iSuite.GetPageURLs(chPage) var chImgs []&lt;-chan string for i := 0; i &lt; countFanOut; i++ { ch := iSuite.GetImgURLs(chPage, chFailedImg) chImgs = append(chImgs, ch) } // 回收多个channel的结果 chImg := merge(chImgs...) // for debug // for { // select { // case v, ok := &lt;-chImg: // if !ok { // return // } // fmt.Println(v, ok) // } // } var chDownloads []&lt;-chan string for i := 0; i &lt; countFanOut; i++ { ch := iSuite.Download(chImg, chFailedImg, folderPath) chDownloads = append(chDownloads, ch) } finish := merge(chDownloads...) for ret := range finish { fmt.Println("finish: ", ret) } } 在上面的代码中，chImg在merge结果的时候，注释代码是去测试结果的。
...</p></div><footer class=entry-footer>2 min&nbsp;·&nbsp;Peter</footer><a class=entry-link aria-label="post link to " href=https://26huitailang.github.io/posts/golang/goroutine/channel/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent></h2></header><div class=entry-content><p>Profiling 在计算机性能调试领域里，profiling 就是对应用的画像，这里画像就是应用使用 CPU 和内存的情况。也就是说应用使用了多少 CPU 资源？都是哪些部分在使用？每个函数使用的比例是多少？有哪些函数在等待 CPU 资源？知道了这些，我们就能对应用进行规划，也能快速定位性能瓶颈。
在 go 语言中，主要关注的应用运行情况主要包括以下几种：
CPU profile：报告程序的 CPU 使用情况，按照一定频率去采集应用程序在 CPU 和寄存器上面的数据 Memory Profile（Heap Profile）：报告程序的内存使用情况 Block Profiling：报告 goroutines 不在运行状态的情况，可以用来分析和查找死锁等性能瓶颈 Goroutine Profiling：报告 goroutines 的使用情况，有哪些 goroutine，它们的调用关系是怎样的 go 提供了：
runtime/pprof，适合一次性运行的程序 net/http/pprof，web服务型的使用 服务应用型 import _ "net/http/pprof" 结果 flat：给定函数上运行耗时 flat%：同上的 CPU 运行耗时总比例 sum%：给定函数累积使用 CPU 总比例 cum：当前函数加上它之上的调用运行总耗时 cum%：同上的 CPU 运行耗时总比例 参考 使用 pprof 和火焰图调试 golang 应用 Tutorial for optimizing golang program</p></div><footer class=entry-footer>1 min&nbsp;·&nbsp;Peter</footer><a class=entry-link aria-label="post link to " href=https://26huitailang.github.io/posts/golang/profiling/profiling/></a></article><article class=post-entry><header class=entry-header><h2 class=entry-hint-parent></h2></header><div class=entry-content><p>交叉编译 Golang 交叉编译与选择性编译 树莓派cmd CGO_ENABLED=0 GOOS=linux GOARCH=arm go build xxx.go 问题 如果依赖库使用了如C、C++，那么交叉编译的时候是需要打开CGO_ENABLED=1，并制定CC参数（cross compiler）
这里以macos darwin为例，我要在mac上写好代码，要编译后调试逻辑
使用docker放到对应环境中编译，需要安装docker，建议，避免环境不一致的问题 docker run --rm -v `pwd`:/code golang:1.18-rc bash -c "ls /code && ls /code/deploy && cd /code && /usr/local/go/bin/go build -o /code/deploy/20220905235741/yogo ./"` 使用macos-cross-toolchains brew tap messense/macos-cross-toolchains # install x86_64-unknown-linux-gnu toolchain brew install x86_64-unknown-linux-gnu # install aarch64-unknown-linux-gnu toolchain brew install aarch64-unknown-linux-gnu # build GOOS=linux GOARCH=amd64 CGO_ENABLED=1 CC=x86_64-unknown-linux-gnu-gcc go build 使用musl（类似glibc），需要运行环境安装musl库，如apt install musl，否则会提示no such file brew install FiloSottile/musl-cross/musl-cross GOOS=linux GOARCH=amd64 CGO_ENABLED=1 CC=x86_64-linux-musl-gcc go build</p></div><footer class=entry-footer>1 min&nbsp;·&nbsp;Peter</footer><a class=entry-link aria-label="post link to " href=https://26huitailang.github.io/posts/golang/%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91/></a></article><footer class=page-footer><nav class=pagination><a class=prev href=https://26huitailang.github.io/page/12/>«&nbsp;Prev&nbsp;
</a><a class=next href=https://26huitailang.github.io/page/14/>Next&nbsp;&nbsp;»</a></nav></footer></main><footer class=footer><span>&copy; 2024 <a href=https://26huitailang.github.io/>Peter's Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>